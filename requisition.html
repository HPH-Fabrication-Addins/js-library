<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript" src="cinx-api.js"></script>
    <script type="text/javascript" src="demo.js"></script>
</head>

<body>
    <div id="sidenavId" class="sidenav"></div>

    <div id="main" class="main">
        <h1>Create Requisition</h1>
        <div id="Demo">

            <label>Organization:
                        <select id='organizations' name="organizations" onchange="fillCatalogList(this.value)"></select>
                    </label>
            <label>Catalog:
                        <select id='catalogs' name="catalogs"></select>
                    </label>
            <br />
            <br />
            <div>
            </div>

            <br/>
            <br/>
            <button class="button" id="action" onclick="createRequisition()">Execute</button>
            <br/>
            <br/>
            <div id="divResponse"></div>
        </div>

        <div id="Code" class="tabcontent"></div>

    </div>

    </div>

</body>

<script type="text/javascript">
    createSidebar();
    if (IsLogged()) {
        fillOrganizationList('organizations');
        fillCatalogList(0);
    } else {
        document.getElementById("action").disabled = true;
    }

    function removeEmptyProperties(obj) {
        Object.keys(obj).forEach(function(key) {
            if (obj[key] && typeof obj[key] === 'object') removeEmptyProperties(obj[key]); //recursive for objects
            else if (obj[key] == null || obj[key] == "") delete obj[key]; //remove empty properties
            if (typeof obj[key] === 'object' && Object.keys(obj[key]).length == 0) delete obj[key]; //remove empty objects
        });
    };

    function createRequisition() {
        var itemTemplate = '';
        var transReferenceTemplate = '';
        var requisitionTemplate = '';
        

		var selected2b = document.getElementById('catalogs').value;
        cinxApi.getRequisitionTemplate(selected2b)
        .then(function(response) {
                console.log(response);
                itemTemplate = JSON.stringify(response.rows[0].template.items[0]);
                transReferenceTemplate = JSON.stringify(response.rows[0].template.transaction_references[0]);
                delete response.rows[0].template.items[0]
                delete response.rows[0].template.transaction_references[0];
                requisition = response.rows[0].template;

                requisition.name = 'Test Requisition';
                requisition.number = 'Test 1000';

                let item1 = JSON.parse(itemTemplate);
                item1.hph_code = 'HPH001';
                item1.quantity = 5;

                requisition.items.push(item1);

                let item2 = JSON.parse(itemTemplate);
                item1.hph_code = 'HPH002';
                item1.quantity = 3;

                requisition.items.push(item2);

                cinxApi.putRequisition(selected2b, requisition)
                .then(function(response) {
                        console.log(response);
                });

        });
    
    

        /* var requisition = JSON.parse(template).template;
        var item = JSON.parse(template).item_template;

        item.quantity = 2;
        item.hph_code = 'HPH123';
        console.log(item);

        requisition.number = 'REQ123';
        requisition.name = 'REQUISITION 123';
        requisition.project.number = 'WTS-2017-01';

        requisition.items.push(item);
        console.log(requisition);

        Http.send(JSON.stringify(requisition));
		//Http.send(requisition);

        Http.onreadystatechange = (e) => {
            console.log(Http.responseText)
        } */
    }
</script>

</html>