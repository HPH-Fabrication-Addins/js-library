<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript" src="cinx-api.js"></script>
    <script type="text/javascript" src="demo.js"></script>
    <script type="text/javascript" src="cinx.js"></script>
</head>

<body>
    <div id="sidenavId" class="sidenav"></div>

    <div id="main" class="main">
        <h1>Create Requisition</h1>
        <div class="tab">
            <button class="tablink" onclick="openPage('Demo', this, '#777')" id="defaultOpen">Demo</button>
            <button class="tablink" onclick="openPage('Code', this, '#777')">Documentation/Code</button>
        </div>

        <div id="Demo" class="tabcontent">

            <label>Organization:
                        <select id='organizations' name="organizations" onchange="fillCatalogList(this.value)"></select>
                    </label>
            <label>Catalog:
                        <select id='catalogs' name="catalogs"></select>
                    </label>
            <br />
            <br />
            <div>
            </div>

            <br/>
            <br/>
            <button class="button" id="action" onclick="createRequisition()">Execute</button>
            <br/>
            <br/>
            <div id="divResponse"></div>
        </div>

        <div id="Code" class="tabcontent"></div>

    </div>

    </div>

</body>

<script type="text/javascript">
    var template = `{
	"doc_info": {
		"type": "JSON-REQ-IMPORT-TEMPLATE",
		"description": "API template for creating a CINX Requisition.",
		"version": "2.01",
		"last_updated": "2019-04-15 15:14:56Z"
	},
	"template": {
		"cinx_guid": "",
		"number": "", X
		"name": "", X
		"description": "",
		"tx_sub_type": "",
		"user_comment": "",
		"procurement_status": "OPEN",
		"allow_substitutes": "true", X
		"cinx_user_guid_assign_to": "",
		"dates": {
			"need_by": "", X
			"approved": "",
			"closed": ""
		},
		"vendor": {
			"number": "",
			"cinx_commerce_guid": ""
		},
		"project": {
			"number": "",
			"cinx_guid": ""
		},
		"delivery": {
			"address1": "",
			"address2": "",
			"address3": "",
			"city": "",
			"state": "",
			"postal_code": "",
			"country": "USA",
			"ship_via": "",
			"fob_type": "",
			"ship_from": "",
			"attention": "",
			"location_type": "JOB SITE", X
			"location_name": "",
			"instructions": ""
		},
		"job_cost_defaults": {
			"phase_name": "",
			"cinx_phase_guid": "",
			"cost_code_name": "",
			"cinx_cost_code_guid": "",
			"category_name": "",
			"cinx_category_guid": ""
		},
		"taxes": {
			"taxable": "false",
			"tax_group_name": "",
			"cinx_tax_group_guid": ""
		},
		"transaction_references": [],
		"items": []
	},
	"transaction_reference_template":{
		"type": "",
		"description": "",
		"value": ""
	},
	"item_template":{
			"quantity": "", X
			"need_by_date": "", X
			"allow_substitutes": "true", X
			"hph_code": "", X
			"org_item_id": "",
			"org_system_id": "",
			"mfr_part_number": "",
			"upc": "",
			"size": "",
			"description": "", X
			"mfr_name": "",
			"item_type": "",
			"vendor": {
				"number": "",
				"cinx_commerce_guid": ""
			},
			"project": {
				"number": "",
				"cinx_guid": ""
			},
			"delivery": {
				"deliver_to": "",
				"location_type": "JOB SITE", X
				"instructions": "",
				"labeling_instructions": "",
				"packaging_instructions": ""
			},
			"work_breakdown": {
				"work_order_id": "",
				"work_order_name": "", X
				"spool_id": "",
				"spool_number": "", 
				"building_name": "",
				"level": "",
				"space": "",
				"sub_space": "",
				"system": "",
				"arch_symbol": ""
			},
			"job_cost": {
				"phase_name": "",
				"cinx_phase_guid": "",
				"cost_code_name": "",
				"cinx_cost_code_guid": "",
				"category_name": "",
				"cinx_category_guid": ""
			},
			"taxes": {
				"taxable": "false",
				"tax_group_name": "",
				"cinx_tax_group_guid": ""
			},
			"design": {
				"model_item_guid": "",
				"model_name": "",
				"model_file": "",
				"drawing_number": "",
				"drawing_name": ""
		}
	},
	"transaction_field_options": {
		"location_type": ["JOB SITE,OFFICE,WAREHOUSE,FABRICATION SHOP,FABRICATOR"],
		"ship_via": ["SUPPLIER TRUCK,MOTOR COMMON CARRIER,CUSTOMER PICKUP,TRACKING GROUND,GROUND,AIR EXPRESS,AIR,PRIVATE PARCEL SERVICE"],
		"fob_type": ["PREPAID AND CHARGED TO CUSTOMER,PREPAID,PICK-UP,COLLECT,DEFINED BY BUYER AND SELLER"],
		"allow_substitutes": ["true,false"],
		"taxable": ["true,false"],
		"tx_sub_type": ["OFFICE,SHOP,FIELD,RENTAL,CONTRACTOR"],
		"procurement_status": ["OPEN,SUBMITTED,IN-REVIEW,APPROVED,APPROVED W/MODS,REJECTED,PENDING ORDER,COMPLETE,CLOSED,CANCELLED,RESUBMITTED"]
	},
	"item_field_options": {
		"location_type": ["JOB SITE,OFFICE,WAREHOUSE,FABRICATION SHOP,FABRICATOR"],
		"ship_via": ["SUPPLIER TRUCK,MOTOR COMMON CARRIER,CUSTOMER PICKUP,TRACKING GROUND,GROUND,AIR EXPRESS,AIR,PRIVATE PARCEL SERVICE"],
		"allow_substitutes": ["true,false"],
		"taxable": ["true,false"],
		"procurement_status": ["NOT ORDERED,ORDER REQUESTED,ORDER PENDING,ORDERED,BACKORDERED,DELIVERED,RETURNED,CANCELLED"]
	},
	"api_calls": [
		{
			"type": "THIS CALL",
			"url": "https://api.cinx.com/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/api/developer/template?type=JSON-REQ-IMPORT-TEMPLATE&section=ALL",
			"note": "Returns this page"
		},
		{
			"type": "REQUISTION SUBMIT",
			"url": "https://api.cinx.com/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/partner/exec/cinx/json-req-import",
			"notes": "Authenticated call user credentials required, post .JSON iport file"
		},
		{
			"type": "VENDORS GET LIST",
			"url": "https://api.cinx.com/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/...",
			"note": "Authenticated call user credentials required"
		},
		{
			"type": "PROJECTS GET LIST",
			"url": "https://api.cinx.com/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/...",
			"note": "Authenticated call user credentials required"
		},
		{
			"type": "USERS GET LIST ",
			"url": "https://api.cinx.com/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/...",
			"note": "Authenticated call user credentials required"
	}]
}`;

    createSidebar();
    if (IsLogged()) {
        fillOrganizationList('organizations');
        fillCatalogList(0);
    } else {
        document.getElementById("action").disabled = true;
    }
    document.getElementById("defaultOpen").click();

    function removeEmptyProperties(obj) {
        Object.keys(obj).forEach(function(key) {
            if (obj[key] && typeof obj[key] === 'object') removeEmptyProperties(obj[key]); //recursive for objects
            else if (obj[key] == null || obj[key] == "") delete obj[key]; //remove empty properties
            if (typeof obj[key] === 'object' && Object.keys(obj[key]).length == 0) delete obj[key]; //remove empty objects
        });
    };

    function createRequisition1() {
        document.getElementById('divResponse').innerHTML = '';

        var b2b = document.getElementById('catalogs').value;
        console.log(b2b);
        var requisition = JSON.parse(template).template;
        var item = JSON.parse(template).item_template;

        item.quantity = 2;
        item.hph_code = 'HPH123';
        console.log(item);

        requisition.number = 'REQ123';
        requisition.name = 'REQUISITION 123';
        requisition.project.number = 'C2NR';

        requisition.items.push(item);
        //removeEmptyProperties(requisition);
        console.log(requisition);
        cinxApi.putRequisition(b2b, requisition)
            .then(function(response) {
                console.log(response);
            });
    }

    function createRequisition() {
        const Http = new XMLHttpRequest();
        const url = 'https://api.dev.cinx.biz/sub/dfed7d88-adf8-5356-8029-fe061c93d0fe/partner/exec/cinx/json-req-import';
        Http.open("POST", url);
        Http.setRequestHeader('Authorization', 'Basic ' + btoa('willstone@cinx.com' + ':' + 'mcphaul18'));
        Http.setRequestHeader('Content-Type', 'application/json');

        var requisition = JSON.parse(template).template;
        var item = JSON.parse(template).item_template;

        item.quantity = 2;
        item.hph_code = 'HPH123';
        console.log(item);

        requisition.number = 'REQ123';
        requisition.name = 'REQUISITION 123';
        requisition.project.number = 'HQ Oct 23';

        requisition.items.push(item);
        console.log(requisition);

        Http.send(JSON.stringify(requisition));

        Http.onreadystatechange = (e) => {
            console.log(Http.responseText)
        }
    }
</script>

</html>