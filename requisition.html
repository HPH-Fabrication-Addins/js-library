<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script type="text/javascript" src="cinx-api.js"></script>
    <script type="text/javascript" src="demo.js"></script>
</head>

<body>
    <div id="sidenavId" class="sidenav"></div>

    <div id="main" class="main">
        <h1>Create Requisition</h1>
        <div id="Demo">

            <label>Organization:
                        <select id='organizations' name="organizations" onchange="fillCatalogList(this.value)"></select>
                    </label>
            <label>Catalog:
                        <select id='catalogs' name="catalogs"></select>
                    </label>
            <br />
            <div id='requisitiondiv' name='requisitiondiv' ><br/>
                <h2>Requisition Header</h2>
                <label>Number:</label>
                <input id='number' name="number">
                <label>Name:</label>
                <input id='name' name="name">
                <label>Allow Substitutes:</label>
                <select id='allows' name="allows">
                        <option value="true">True</option>
                        <option value="false">False</option>
                </select></br>
                <label>Need By:</label>
                <input type="date" id='needby' name="needby">
                <label>Delivery Location Type:</label>
                <select id='loctype' name="loctype"></select></br>
                <h2>Requisition Items</h2>
                <label>Quantity:</label>
                <input id='qty' name="qty"></input>
                <label>Need By:</label>
                <input type="date" id='idate' name="idate"><br/>
                <label>HPH Code:</label>
                <input id='hph' name="hph"></input>
                <label>Description:</label>
                <input id='desc' name="desc">
                <label>Delivery Location Type:</label>
                <select id='iloctype' name="iloctype"></select> 
                <button class="button" id="putitem" onclick="putItem()">Put Item</button>
                <hr/>
                <div id="itemslist"></div>

            </div>
            <br/>
            <div>
            </div>

            <br/>
            <br/>
            <button class="button" id="action" onclick="createRequisition()">Execute</button>
            <br/>
            <br/>
            <div id="divResponse"></div>
        </div>

        <div id="Code" class="tabcontent"></div>

    </div>

    </div>

</body>

<script type="text/javascript">
    createSidebar();
    if (IsLogged()) {
        fillOrganizationList('organizations');
        fillCatalogList(0);
    } else {
        document.getElementById("action").disabled = true;
    }

    var requisitionObject = '';
    var itemTtemplate = '';
    var transReferenceTemplate = '';

    var reqLocationTypes = '';
    var itemLocationTypes = '';

    var selected2b = document.getElementById('catalogs').value;
    cinxApi.getRequisitionTemplate(selected2b)
        .then(function(response) {
                this.console.log(response);
                itemTemplate = JSON.stringify(response.rows[0].template.items[0]);
                transReferenceTemplate = JSON.stringify(response.rows[0].template.external_references[0]);
                response.rows[0].template.items = [];
                response.rows[0].template.external_references = [];
                requisitionObject = response.rows[0].template;

                reqLocationTypes = response.rows[0].field_options['delivery.location_type'];
                this.console.log(reqLocationTypes);

                itemLocationTypes = response.rows[0].field_options['items.delivery.location_type'];
                this.console.log(itemLocationTypes);

                reqLocationTypes.forEach(el => {
                document.getElementById('loctype').innerHTML += `<option value='${el}'>${el}</option>`;
                });

                itemLocationTypes.forEach(el => {
                document.getElementById('iloctype').innerHTML += `<option value='${el}'>${el}</option>`;
                });
        });

    function removeEmptyProperties(obj) {
        Object.keys(obj).forEach(function(key) {
            if (obj[key] && typeof obj[key] === 'object') removeEmptyProperties(obj[key]); //recursive for objects
            else if (obj[key] == null || obj[key] == "") delete obj[key]; //remove empty properties
            if (typeof obj[key] === 'object' && Object.keys(obj[key]).length == 0) delete obj[key]; //remove empty objects
        });
    };

    function createRequisition() {

        requisitionObject.number = document.getElementById('number').value;
        requisitionObject.name = document.getElementById('name').value;
        requisitionObject.dates.need_by = document.getElementById('needby').value;
        requisitionObject.allow_substitutes = document.getElementById('allows').value;
        requisitionObject.delivery.location_type = document.getElementById('loctype').value;
        
        
        cinxApi.putRequisition(selected2b, requisitionObject)
                .then(function(response) {
                        console.log(response);
        });
    }

    function putItem() {
        var item = JSON.parse(itemTemplate);
        item.quantity = document.getElementById('qty').value;
        item.need_by_date = document.getElementById('idate').value;
        item.hph_code = document.getElementById('hph').value;
        item.description = document.getElementById('desc').value;
        item.delivery.location_type = document.getElementById('iloctype').value;
        requisitionObject.items.push(item);
        document.getElementById('itemslist').innerHTML = '';
        requisitionObject.items.forEach(el => {
                document.getElementById('itemslist').innerHTML += `HPH Code: ${el.hph_code} Quantity: ${el.quantity} Description: ${el.description} <br/>`;
                })
    }
</script>

</html>